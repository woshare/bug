#PGPHttp项目Debug总结
>1,多线程编程     
>2,异步编程      

##bug0：GNET::Octets buff = gulr.Encode();可能因为多线程导致map插入数据异常，引发segfault，原因待定


##bug1：运行game_proxy，httpSession对象生成太快，处理太慢，导致oom

###为什么会oom？

####原因
>1， **生成对象，加锁插入map{key，value}，但是key生成是重复的**，导致有的value被挤走，内存回收全value对象自身的生命周期，没办法及时将异常的状态的value及时内存回收      
>2， **端口不足**（cat /proc/sys/net/ipv4/ip_local_port_range 可以得到系统可用端口范围，约2.8万），**网络操作connect执行缓慢，呈现阻塞态势，导致生成的HttpSession对象堆积**          
>3， **超时淘汰，关闭socket，timer，resolve等，不会直接促使某些绑定好的等待的异步操作而失效，在某些情景下，这些等待的异步操作被激活，依然可以向前继续执行，导致超时淘汰失效，内存回收慢**

####Debug方案
>1，解决原因1，反复查看源代码，查找代码中的bug，使生成的map key唯一           
>2，端口不足，可以修改系统参数，使timewait状态的socket及时回收（sysctl -w net.ipv4.tcp_timestamps=1  开启对于TCP时间戳的支持,若该项设置为0，则下面一项设置不起作用；sysctl -w net.ipv4.tcp_tw_recycle=1  表示开启TCP连接中TIME-WAIT sockets的快速回收），或者适当的增加系统配置的可用端口范围           
>3，1）代码统计各个操作的状态：比如HttpSession对象生成，网络操作（DNS,Connect，HandShark，Send，Read，Close，Timeout等及其异常状态情况），析构进行统计，按照刚才描述顺序，是一个倒三角型，**即每个步骤都有堆积**        
>3，2）strace命令（ strace -o out.txt  -f -t -c -e trace=all -p PID）或者perf top查看系统开销在哪些函数上，**发现connect步骤，开销占用了三分之二，其次是futex的一个锁操作**，约占用系统开销20%，如此可以判断是 **端口不足，网络connect操作缓慢导致HttpSession对象堆积，从而导致OOM**

###每个线程都在做什么？

####实验参数
>启用8个工作线程，每秒生成5000请求

####分析每个线程
>1， **gdb attach pid ，bt或者pstack pid**

####现象
>1，启用8个工作线程，top -H 查看同一进程下一共会有10个线程（分别是1一个main线程，8个工作线程，1个dns resolve线程）             
>2，**CPU占用：1个main线程：40~50% （主要生成请求）  8个工作线程：80~90+% （网络操作，其中又主要消耗在connect步骤）   1个DNS resolve线程：~5%**


####结论
>1，不修改系统加速回收端口的参数情况下，**4个线程，5000QPS**,程序大约20分钟oom            
>2，不修改系统加速回收端口的参数情况下，**8个线程，5000QPS**，依然存在oom的可能，即可能多少小时之后，还是会 **有可能oom**,  **8个工作线程长时间分别稳定在CPU 90+%,MEM ~60%**        
>3，不修改系统加速回收端口的参数情况下，**8个线程，2000QPS**，目前大约2个小时了 **没出现异常**，**8个工作线程长时间分别稳定在CPU 30~50%,MEM ~20%**        
>4，不修改系统加速回收端口的参数情况下，会有 **约~30% connect: Cannot assign requested address** 报错，并且存在~50%的请求超时淘汰           
>5，修改系统加速回收端口的参数情况下， **8个线程，2000QPS，0 err 千分之一左右的超时淘汰**， **8个工作线程长时间分别稳定在CPU ~10%,MEM ~1%**, **主要开销在锁的开销和写日志的开销**       
>6，修改系统加速回收端口的参数情况下，**8个线程，5000QPS**，**0 err 千分之一左右的超时淘汰**，**8个工作线程长时间分别稳定在CPU ~10%,MEM ~1%**, **主要开销在锁的开销和写日志的开销**


####建议
>1，修改系统加速回收端口的参数              
>2，并编写脚本，实时检测程序是否在运行，及时重启                  







